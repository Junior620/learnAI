<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSPD LearnAI - Tableau de bord √âtudiant</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                <div>
                    <h1>üéì Tableau de bord √âtudiant</h1>
                    <p id="welcomeMessage">Bienvenue</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="window.location.href='chatbot.html'">üí¨ Chatbot</button>
                    <button class="btn btn-secondary" onclick="window.location.href='settings.html'">‚öôÔ∏è Param√®tres</button>
                    <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
                </div>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3 id="avgScore">--</h3>
                <p>Moyenne G√©n√©rale</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h3 id="maxScore">--</h3>
                <p>Meilleure Note</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <h3 id="totalGrades">--</h3>
                <p>Total Notes</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <h3 id="successProb">--</h3>
                <p>Probabilit√© de R√©ussite</p>
            </div>
        </div>

        <!-- Pr√©dictions IA -->
        <div class="card">
            <h2 class="card-title">ü§ñ Analyse IA de vos Performances</h2>
            <div id="predictionContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyse en cours...</p>
                </div>
            </div>
        </div>

        <!-- Notes r√©centes -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="card-title">üìä Vos Notes R√©centes</h2>
                <button class="btn btn-primary" onclick="window.location.href='grades.html'">
                    Voir toutes mes notes ‚Üí
                </button>
            </div>
            <div id="gradesTable">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Recommandations -->
        <div class="card">
            <h2 class="card-title">üìö Ressources Recommand√©es</h2>
            <button class="btn btn-primary" onclick="window.location.href='recommendations.html'">
                Voir toutes les recommandations
            </button>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        // V√©rifier l'authentification
        if (!isAuthenticated()) {
            window.location.href = 'index.html';
        }

        const user = getUser();
        document.getElementById('welcomeMessage').textContent = `Bienvenue, ${user.first_name} ${user.last_name}`;

        // Charger les donn√©es
        async function loadDashboard() {
            try {
                // Charger les statistiques
                const dashboard = await getStudentDashboard();
                
                if (dashboard.statistics) {
                    const stats = dashboard.statistics;
                    document.getElementById('avgScore').textContent = stats.avg_score ? parseFloat(stats.avg_score).toFixed(2) : '--';
                    document.getElementById('maxScore').textContent = stats.max_score ? parseFloat(stats.max_score).toFixed(2) : '--';
                    document.getElementById('totalGrades').textContent = stats.total_grades || '0';
                }

                // Afficher les notes
                if (dashboard.grades && dashboard.grades.length > 0) {
                    displayGrades(dashboard.grades);
                } else {
                    document.getElementById('gradesTable').innerHTML = '<p>Aucune note disponible</p>';
                }

                // Charger les pr√©dictions
                loadPredictions();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadPredictions() {
            try {
                const predictions = await getPredictions();
                
                if (predictions && predictions.success_probability !== undefined) {
                    const prob = (parseFloat(predictions.success_probability) * 100).toFixed(0);
                    document.getElementById('successProb').textContent = `${prob}%`;
                    
                    // Utiliser le message personnalis√© du backend
                    if (predictions.performance_message && predictions.average_score) {
                        const msg = predictions.performance_message;
                        const avg = predictions.average_score;
                        
                        let alertClass = 'alert-info';
                        if (msg.level === 'excellent' || msg.level === 'very_good' || msg.level === 'good') {
                            alertClass = 'alert-success';
                        } else if (msg.level === 'average' || msg.level === 'warning') {
                            alertClass = 'alert-warning';
                        } else if (msg.level === 'concerning' || msg.level === 'critical') {
                            alertClass = 'alert-danger';
                        }
                        
                        const riskHTML = `
                            <div class="alert ${alertClass}">
                                ${msg.emoji} <strong>${msg.title} - Moyenne: ${avg}/20</strong><br>
                                ${msg.message}<br>
                                <em>üí° Conseil: ${msg.advice}</em>
                            </div>
                        `;
                        
                        document.getElementById('predictionContent').innerHTML = riskHTML;
                    } else {
                        // Fallback si pas de message du backend
                        const avgScore = parseFloat(document.getElementById('avgScore').textContent) || 0;
                        const riskHTML = getPerformanceMessage(avgScore);
                        document.getElementById('predictionContent').innerHTML = riskHTML;
                    }
                } else {
                    document.getElementById('successProb').textContent = 'N/A';
                    document.getElementById('predictionContent').innerHTML = '<p>üìä Pas assez de donn√©es pour une pr√©diction IA. Continuez √† obtenir des notes !</p>';
                }
            } catch (error) {
                console.error('Erreur pr√©dictions:', error);
                document.getElementById('successProb').textContent = 'N/A';
                document.getElementById('predictionContent').innerHTML = '<p>‚ö†Ô∏è Service de pr√©diction temporairement indisponible</p>';
            }
        }

        function getPerformanceMessage(avg) {
            // Messages de fallback si le backend ne r√©pond pas
            if (avg >= 18) {
                return '<div class="alert alert-success">üèÜ <strong>Excellence acad√©mique - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Performances exceptionnelles ! Vous √™tes parmi les meilleurs. Continuez √† viser l\'excellence et inspirez vos camarades.</div>';
            } else if (avg >= 16) {
                return '<div class="alert alert-success">‚≠ê <strong>Tr√®s bonnes performances - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Excellent travail ! Vous ma√Ætrisez bien vos mati√®res. Maintenez cette dynamique pour atteindre l\'excellence.</div>';
            } else if (avg >= 14) {
                return '<div class="alert alert-success">‚úÖ <strong>Bonnes performances - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Vous √™tes sur la bonne voie ! Continuez vos efforts et visez encore plus haut. La r√©ussite est assur√©e.</div>';
            } else if (avg >= 12) {
                return '<div class="alert alert-info">üëç <strong>Performances satisfaisantes - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Vous √™tes dans la moyenne sup√©rieure. Avec plus de travail r√©gulier, vous pouvez atteindre de tr√®s bons r√©sultats.</div>';
            } else if (avg >= 10) {
                return '<div class="alert alert-warning">‚ö° <strong>Performances moyennes - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Vous validez vos mati√®res mais pouvez faire mieux. Identifiez vos points faibles et travaillez-les r√©guli√®rement.</div>';
            } else if (avg >= 9) {
                return '<div class="alert alert-warning">‚ö†Ô∏è <strong>Attention requise - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Vous √™tes juste en dessous de la moyenne. Redoublez d\'efforts, consultez vos enseignants et utilisez le chatbot pour des conseils.</div>';
            } else if (avg >= 8) {
                return '<div class="alert alert-danger">üö® <strong>Situation pr√©occupante - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Vos r√©sultats sont faibles. Il est urgent de r√©agir : assistez aux cours de soutien, travaillez r√©guli√®rement et demandez de l\'aide.</div>';
            } else {
                return '<div class="alert alert-danger">‚ùå <strong>Risque d\'√©chec √©lev√© - Moyenne: ' + avg.toFixed(2) + '/20</strong><br>Situation critique ! Consultez imm√©diatement vos enseignants, suivez un plan de rattrapage et utilisez toutes les ressources disponibles.</div>';
            }
        }

        function displayGrades(grades) {
            const html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Mati√®re</th>
                            <th>Type</th>
                            <th>Note</th>
                            <th>Semestre</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${grades.slice(0, 10).map(g => `
                            <tr>
                                <td>${g.subject_name}</td>
                                <td>${g.grade_type}</td>
                                <td><strong>${g.score}/20</strong></td>
                                <td>${g.semester}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('gradesTable').innerHTML = html;
        }

        // Charger au d√©marrage
        loadDashboard();
    </script>
</body>
</html>
